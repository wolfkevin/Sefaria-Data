# -*- coding: utf-8 -*-

__author__ = 'stevenkaplan'
from sources.functions import *
from sefaria.model import *
from data_utilities.XML_to_JaggedArray import XML_to_JaggedArray
from sefaria.helper.schema import *
import bleach



def create_schema():
    root = SchemaNode()
    root.add_primary_titles("Responsa of R' Moshe Feinstein",
                            u"תשובות ר' משה פיינשטיין")
    children_responsa = ['Introduction / \xd7\x94\xd7\xa7\xd7\x93\xd7\x9e\xd7\x94', 'Preface to Iggeros Moshe, vol I (1959) / \xd7\x9e\xd7\x91\xd7\x95\xd7\x90 \xd7\x9c\xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x97\xd7\x9c\xd7\xa7 \xd7\x90 (\xd7\xaa\xd7\xa9\xd7\x99\xe2\x80\x9d\xd7\x98)', "Iggeros Moshe, Yoreh De'ah III:132 (5 Iyyar 5736 [May 5, 1976]) / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x99\xd7\x95\xd7\xa8\xd7\x94 \xd7\x93\xd7\xa2\xd7\x94,\xd7\x92, \xd7\xa7\xd7\x9c\xd7\x91", 'A New Teshuvah [Rosh Chodesh Kislev 5746 (Nov 14, 1985)] / \xd7\xaa\xd7\xa9\xd7\x95\xd7\x91\xd7\x94 \xd7\x97\xd7\x93\xd7\xa9\xd7\x94', 'Iggeros Moshe, Choshen Mishpat II:72 [Rosh Chodesh Adar II, 5738 (March 10, 1978)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x97\xd7\x95\xd7\xa9\xd7\x9f \xd7\x9e\xd7\xa9\xd7\xa4\xd7\x98, \xd7\x91, \xd7\xa2\xd7\x91', 'Iggeros Moshe, Choshen Mishpat II:73 [16 Iyyar 5742 (May 9, 1982)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x97\xd7\x95\xd7\xa9\xd7\x9f \xd7\x9e\xd7\xa9\xd7\xa4\xd7\x98, \xd7\x91, \xd7\xa2\xd7\x92', 'Iggeros Moshe, Choshen Mishpat II:74 [23 Adar II 5744 (March 27, 1984)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x97\xd7\x95\xd7\xa9\xd7\x9f \xd7\x9e\xd7\xa9\xd7\xa4\xd7\x98, \xd7\x91, \xd7\xa2\xd7\x93', 'Iggeros Moshe, Choshen Mishpat II:75 [Lag BeOmer 18 Iyyar 5744] (May 20, 1984) / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x97\xd7\x95\xd7\xa9\xd7\x9f \xd7\x9e\xd7\xa9\xd7\xa4\xd7\x98, \xd7\x91, \xd7\xa2\xd7\x94', 'The Anatomy of a Teshuvah / \xd7\x90\xd7\xa0\xd7\x98\xd7\x95\xd7\x9e\xd7\x99\xd7\x94 \xd7\xa9\xd7\x9c \xd7\xaa\xd7\xa9\xd7\x95\xd7\x91\xd7\x94', 'Talmudic Sources / \xd7\x9e\xd7\xa7\xd7\x95\xd7\xa8\xd7\x95\xd7\xaa \xd7\xaa\xd7\x9c\xd7\x9e\xd7\x95\xd7\x93\xd7\x99\xd7\x99\xd7\x9d', 'Analysis Of The Talmudic Sources / \xd7\xa0\xd7\x99\xd7\xaa\xd7\x95\xd7\x97 \xd7\x94\xd7\x9e\xd7\xa7\xd7\x95\xd7\xa8\xd7\x95\xd7\xaa \xd7\x94\xd7\xaa\xd7\x9c\xd7\x9e\xd7\x95\xd7\x93\xd7\x99\xd7\x99\xd7\x9d ', 'Later Sources / \xd7\x9e\xd7\xa7\xd7\x95\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\x90\xd7\x95\xd7\x97\xd7\xa8\xd7\x99\xd7\x9d', 'Quality and Sanctity of Life: A Torah View / \xd7\x90\xd7\x99\xd7\x9b\xd7\x95\xd7\xaa \xd7\x97\xd7\x99\xd7\x99\xd7\x9d \xd7\x95\xd7\xa7\xd7\x93\xd7\x95\xd7\xa9\xd7\xaa \xd7\x94\xd7\x97\xd7\x99\xd7\x99\xd7\x9d: \xd7\x9e\xd7\x91\xd7\x98 \xd7\xa9\xd7\x9c \xd7\xaa\xd7\x95\xd7\xa8\xd7\x94', 'Additional Note / \xd7\x94\xd7\xa2\xd7\xa8\xd7\x94 \xd7\x9e\xd7\xa9\xd7\x9c\xd7\x99\xd7\x9e\xd7\x94', 'Clarification of the Halakhic Rulings of Rav Moshe Feinstein and of Rav Shlomo Zalman Auerbach in Regard to Brain Death / \xd7\x94\xd7\x91\xd7\x94\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9c\xd7\x92\xd7\x91\xd7\x99 \xd7\xa4\xd7\xa1\xd7\x99\xd7\xa7\xd7\xaa \xd7\x94\xd7\x94\xd7\x9c\xd7\x9b\xd7\x94 \xd7\xa9\xd7\x9c \xd7\xa8\' \xd7\x9e\xd7\xa9\xd7\x94 \xd7\xa4\xd7\x99\xd7\x99\xd7\xa0\xd7\xa9\xd7\x98\xd7\x99\xd7\x99\xd7\x9f \xd7\x95\xd7\xa8\' \xd7\xa9\xd7\x9c\xd7\x9e\xd7\x94 \xd7\x96\xd7\x9c\xd7\x9e\xd7\x9f \xd7\x90\xd7\x95\xd7\x99\xd7\xa8\xd7\x91\xd7\x9a \xd7\x96\xd7\xa6"\xd7\x9c \xd7\x91\xd7\xa2\xd7\xa0\xd7\x99\xd7\x99\xd7\x9f \xd7\x9e\xd7\x95\xd7\x95\xd7\xaa \xd7\x9e\xd7\x95\xd7\x97\xd7\x99', "Iggeros Moshe, Yoreh De'ah 1:145 [25 Tammuz 8707 (July 13, 1947)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x99\xd7\x95\xd7\xa8\xd7\x94 \xd7\x93\xd7\xa2\xd7\x94, \xd7\x90, \xd7\xa7\xd7\x9e\xd7\x94", 'Introductory Note / \xd7\x94\xd7\xa2\xd7\xa8\xd7\x94 \xd7\x9e\xd7\xa7\xd7\x93\xd7\x99\xd7\x9e\xd7\x94', 'Iggeros Moshe, Orach Chaim IV:79 [17 Adar 5735 (March 16, 1976)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x90\xd7\x95\xd7\xa8\xd7\x97 \xd7\x97\xd7\x99\xd7\x99\xd7\x9d, \xd7\x93, \xd7\xa2\xd7\x98', 'Iggeros Moshe, Orach Chaim IV:81 [2 Rosh Chodesh Adar 5739 (Feb 28, 1979)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x90\xd7\x95\xd7\xa8\xd7\x97 \xd7\x97\xd7\x99\xd7\x99\xd7\x9d, \xd7\x93, \xd7\xa4\xd7\x90', 'Iggeros Moshe, Orach Chaim IV:80 [30 Sivan 5738 (July 5, 1978)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x90\xd7\x95\xd7\xa8\xd7\x97 \xd7\x97\xd7\x99\xd7\x99\xd7\x9d, \xd7\x93, \xd7\xa4', "Iggeros Moshe, Yoreh De'ah II:174 [19 Tammuz 5728 (July 15, 1968)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x99\xd7\x95\xd7\xa8\xd7\x94 \xd7\x93\xd7\xa2\xd7\x94, \xd7\x91, \xd7\xa7\xd7\xa2\xd7\x93", "Iggeros Moshe, Yoreh De'ah II:166 [14 Elul 5724 (Aug 22, 1964)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x99\xd7\x95\xd7\xa8\xd7\x94 \xd7\x93\xd7\xa2\xd7\x94, \xd7\x91, \xd7\xa7\xd7\xa1\xd7\x95", "Iggeros Moshe, Yoreh De'ah II:164 [2 Sivan 5732 (June 6, 1972)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x99\xd7\x95\xd7\xa8\xd7\x94 \xd7\x93\xd7\xa2\xd7\x94, \xd7\x91, \xd7\xa7\xd7\xa1\xd7\x93", "Iggeros Moshe, Yoreh De'ah II:162 [5 Sivan 5723 (May 28, 1963)] / \xd7\x90\xd7\x92\xd7\xa8\xd7\x95\xd7\xaa \xd7\x9e\xd7\xa9\xd7\x94 \xd7\x99\xd7\x95\xd7\xa8\xd7\x94 \xd7\x93\xd7\xa2\xd7\x94, \xd7\x91, \xd7\xa7\xd7\xa1\xd7\x91", 'Unpublished Responsum: "So One May Live" / \xd7\xaa\xd7\xa9\xd7\x95\xd7\x91\xd7\x94 \xd7\xa9\xd7\x9c\xd7\x90 \xd7\xa4\xd7\x95\xd7\xa8\xd7\xa1\xd7\x9e\xd7\x94 "\xd7\x9b\xd7\x93\xd7\x99 \xd7\xa9\xd7\x99\xd7\x97\xd7\x99\xd7\x94 \xd7\x94\xd7\x90\xd7\x97\xd7\x93" ']

    arr = ['Preface / \xd7\x9e\xd7\x91\xd7\x95\xd7\x90',
           'A Biography of Greatness / \xd7\x91\xd7\x99\xd7\x95\xd7\x92\xd7\xa8\xd7\xa4\xd7\x99\xd7\x94 \xd7\xa9\xd7\x9c \xd7\x92\xd7\x93\xd7\x95\xd7\x9c\xd7\x94',
           "Responsa of Rav Moshe Feinstein / \xd7\xaa\xd7\xa9\xd7\x95\xd7\x91\xd7\x95\xd7\xaa \xd7\xa8' \xd7\x9e\xd7\xa9\xd7\x94 \xd7\xa4\xd7\x99\xd7\x99\xd7\xa0\xd7\xa9\xd7\x98\xd7\x99\xd7\x99\xd7\x9f",
           'Quality and Sanctity of Life in the Talmud and Midrash coauthhored by Dr Fred Rosner / איכות חיים וקדושת החיים בתלמוד ובמדרש, נכתב יחד עם ד"ר פרד רושר']

    for line in arr:
        en, he = line.split(" / ")
        he = he.decode('utf-8')
        en = en.title()
        node = JaggedArrayNode()
        node.add_primary_titles(en, he)
        node.add_structure(["Paragraph"])
        root.append(node)

    children_end = ['Introduction / \xd7\x94\xd7\xa7\xd7\x93\xd7\x9e\xd7\x94',
                         'Treatment of the Dying in Judaism / \xd7\x98\xd7\x99\xd7\xa4\xd7\x95\xd7\x9c \xd7\x91\xd7\xa0\xd7\x95\xd7\x98\xd7\x94 \xd7\x9c\xd7\x9e\xd7\x95\xd7\xaa \xd7\x91\xd7\x99\xd7\x94\xd7\x93\xd7\x95\xd7\xaa',
                         'Recent Rabbinic Rulings / \xd7\xa4\xd7\xa1\xd7\x99\xd7\xa7\xd7\x95\xd7\xaa \xd7\x94\xd7\x9c\xd7\x9b\xd7\x94 \xd7\x97\xd7\x93\xd7\xa9\xd7\x95\xd7\xaa',
                         'Quality of Life in Classic Jewish Sources / \xd7\x90\xd7\x99\xd7\x9b\xd7\x95\xd7\xaa \xd7\x97\xd7\x99\xd7\x99\xd7\x9d \xd7\x91\xd7\x9e\xd7\xa7\xd7\x95\xd7\xa8\xd7\x95\xd7\xaa \xd7\x94\xd7\xa7\xd7\x9c\xd7\x90\xd7\xa1\xd7\x99\xd7\x99\xd7\x9d \xd7\xa9\xd7\x9c \xd7\x94\xd7\x99\xd7\x94\xd7\x93\xd7\x95\xd7\xaa', 'Physical Pain / \xd7\x9b\xd7\x90\xd7\x91 \xd7\xa4\xd7\x99\xd7\x96\xd7\x99', 'Mental Anguish / \xd7\x99\xd7\xa1\xd7\x95\xd7\xa8\xd7\x99 \xd7\xa0\xd7\xa4\xd7\xa9',
                         'Summary / \xd7\xa1\xd7\x99\xd7\x9b\xd7\x95\xd7\x9d', 'Notes / \xd7\x94\xd7\xa2\xd7\xa8\xd7\x95\xd7\xaa']

    for child in children_end:
        en, he = child.split(" / ")
        he = he.decode('utf-8')
        en = en.title()
        node = JaggedArrayNode()
        node.add_primary_titles(en, he)
        node.add_structure(["Paragraph"])
        root.children[3].append(node)

    for child in children_responsa:
        en, he = child.split(" / ")
        he = he.decode('utf-8')
        node = JaggedArrayNode()
        en = en.title()
        node.add_primary_titles(en, he)
        node.add_structure(["Paragraph"])
        root.children[2].append(node)

    root.validate()
    index = {
        "schema": root.serialize(),
        "title": "Responsa of R' Moshe Feinstein",
        "categories": ["Halakha", "R' Moshe Feinstein"],
    }
    post_index(index)




def reorder_modify(text):
    return bleach.clean(text, strip=True)

if __name__ == "__main__":
    post_term({
        "name": "R' Moshe Feinstein",
        "scheme": "toc_categories",
        "titles":
        [
            {
            "text": "R' Moshe Feinstein",
            "lang": "en",
            "primary": True
            },
            {
             "text": u"ר׳ משה פיינשטיין‎‎",
            "lang": "he",
            "primary": True
            }
        ]
    })

    create_schema()
    post_info = {}
    post_info["language"] = "en"
    post_info["server"] = sys.argv[1]
    allowed_tags = ["book", "intro", "part", "chapter", "p", "ftnote", "title", "ol", "footnotes", "appendix"]
    allowed_attributes = ["id"]
    p = re.compile("\d+a?\.")

    post_info["versionTitle"] = "Responsa of Rav Moshe Feinstein, trans. by Moshe David Tendler; Vol. 1: Care of the Critically Ill, Hoboken, NJ: Ktav, 1996."
    post_info["versionSource"] = "http://www.ktav.com/index.php/responsa-of-rav-moshe-feinstein.html"
    title = "Responsa of R Moshe Feinstein Vol 1"
    file_name = "responsa.xml"

    parser = XML_to_JaggedArray(title, file_name, allowed_tags, allowed_attributes, post_info, change_name=True, image_dir="./images")
    parser.set_funcs(reorder_test=lambda x: x.tag == "title" and x.text.find("<bold>") == 0, reorder_modify=reorder_modify)
    parser.run()